<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" 
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" 
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI" 
             xmlns:flowable="http://flowable.org/bpmn"
             typeLanguage="http://www.w3.org/2001/XMLSchema" 
             expressionLanguage="http://www.w3.org/1999/XPath" 
             targetNamespace="http://www.flowable.org/processdef"
             id="definitions_bpmn">

  <process id="process_bulk_file_handling" name="Bulk File Processing" isExecutable="true">
    
    <startEvent id="startEvent" name="Start" />
    
    <serviceTask id="task_parse" name="Call Parse API" flowable:type="http">
      <extensionElements>
        <flowable:field name="requestMethod">
          <flowable:string><![CDATA[POST]]></flowable:string>
        </flowable:field>
        
        <flowable:field name="requestUrl">
          <flowable:string><![CDATA[http://localhost:8080/api/files/parse]]></flowable:string>
        </flowable:field>
        
        <flowable:field name="requestHeaders">
          <flowable:string><![CDATA[Content-Type: application/json]]></flowable:string>
        </flowable:field>
        
        <flowable:field name="requestBody">
          <flowable:expression><![CDATA[{"fileId": "${fileId}"}]]></flowable:expression>
        </flowable:field>
        
        <flowable:field name="responseVariableName">
          <flowable:string><![CDATA[parsedResult]]></flowable:string>
        </flowable:field>
      </extensionElements>
    </serviceTask>
    
    <scriptTask id="task_round_robin" name="Calculate Round Robin" scriptFormat="groovy">
      <script>
        // Example logic: Parse the JSON response from the API
        // In a real scenario, you might use groovy.json.JsonSlurper
        
        // For testing/mocking, we still set the assignmentList manually below:
        def assignments = [];
        assignments.add(['cif':'123', 'personId':'P1', 'operator':'user1']);
        assignments.add(['cif':'456', 'personId':'P1', 'operator':'user1']);
        assignments.add(['cif':'789', 'personId':'P2', 'operator':'user2']);
        
        execution.setVariable("assignmentList", assignments);
      </script>
    </scriptTask>
    
    <callActivity id="call_create_case" name="Create Skip Tracing Case" calledElement="skipTracingCase" flowable:caseRef="skipTracingCase" flowable:businessKey="${assignment.cif}">
      <extensionElements>
        <flowable:in sourceExpression="${assignment.cif}" target="cif" />
        <flowable:in sourceExpression="${assignment.operator}" target="assignedOperator" />
        <flowable:in sourceExpression="${assignment.personId}" target="personId" />
      </extensionElements>
      <multiInstanceLoopCharacteristics isSequential="false" flowable:collection="assignmentList" flowable:elementVariable="assignment" />
    </callActivity>
    
    <endEvent id="endEvent" name="End" />

    <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="task_parse" />
    <sequenceFlow id="flow2" sourceRef="task_parse" targetRef="task_round_robin" />
    <sequenceFlow id="flow3" sourceRef="task_round_robin" targetRef="call_create_case" />
    <sequenceFlow id="flow4" sourceRef="call_create_case" targetRef="endEvent" />
  </process>

  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="process_bulk_file_handling">
      <bpmndi:BPMNShape id="shape_start" bpmnElement="startEvent">
        <dc:Bounds x="100" y="100" width="30" height="30" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="shape_parse" bpmnElement="task_parse">
        <dc:Bounds x="180" y="75" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="shape_rr" bpmnElement="task_round_robin">
        <dc:Bounds x="330" y="75" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="shape_call" bpmnElement="call_create_case">
        <dc:Bounds x="480" y="75" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="shape_end" bpmnElement="endEvent">
        <dc:Bounds x="630" y="100" width="30" height="30" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNEdge id="edge_1" bpmnElement="flow1">
        <di:waypoint x="130" y="115" />
        <di:waypoint x="180" y="115" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_2" bpmnElement="flow2">
        <di:waypoint x="280" y="115" />
        <di:waypoint x="330" y="115" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_3" bpmnElement="flow3">
        <di:waypoint x="430" y="115" />
        <di:waypoint x="480" y="115" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="edge_4" bpmnElement="flow4">
        <di:waypoint x="580" y="115" />
        <di:waypoint x="630" y="115" />
      </bpmndi:BPMNEdge>
      
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>